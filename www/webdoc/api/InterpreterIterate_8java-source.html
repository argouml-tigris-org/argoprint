<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ArgoPrint: InterpreterIterate.java Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Packages</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a></div>
<h1>InterpreterIterate.java</h1><a href="InterpreterIterate_8java.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//$Id$</span>
00002 <span class="comment">//Copyright (c) 2003, Mikael Albertsson, Mattias Danielsson, Per Engström, </span>
00003 <span class="comment">//Fredrik Gröndahl, Martin Gyllensten, Anna Kent, Anders Olsson, </span>
00004 <span class="comment">//Mattias Sidebäck.</span>
00005 <span class="comment">//All rights reserved.</span>
00006 <span class="comment">//</span>
00007 <span class="comment">//Redistribution and use in source and binary forms, with or without </span>
00008 <span class="comment">//modification, are permitted provided that the following conditions are met:</span>
00009 <span class="comment">//</span>
00010 <span class="comment">//* Redistributions of source code must retain the above copyright notice, </span>
00011 <span class="comment">//  this list of conditions and the following disclaimer.</span>
00012 <span class="comment">// </span>
00013 <span class="comment">//* Redistributions in binary form must reproduce the above copyright </span>
00014 <span class="comment">//  notice, this list of conditions and the following disclaimer in the </span>
00015 <span class="comment">//  documentation and/or other materials provided with the distribution.</span>
00016 <span class="comment">//</span>
00017 <span class="comment">//* Neither the name of the University of Linköping nor the names of its </span>
00018 <span class="comment">//  contributors may be used to endorse or promote products derived from </span>
00019 <span class="comment">//  this software without specific prior written permission. </span>
00020 <span class="comment">//</span>
00021 <span class="comment">//THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" </span>
00022 <span class="comment">//AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE </span>
00023 <span class="comment">//IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE </span>
00024 <span class="comment">//ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE </span>
00025 <span class="comment">//LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR </span>
00026 <span class="comment">//CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF </span>
00027 <span class="comment">//SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS </span>
00028 <span class="comment">//INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN </span>
00029 <span class="comment">//CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) </span>
00030 <span class="comment">//ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF </span>
00031 <span class="comment">//THE POSSIBILITY OF SUCH DAMAGE.</span>
00032 
00033 <span class="keyword">package </span>org.argoprint.engine.interpreters;
00034 
00035 <span class="keyword">import</span> java.util.Collection;
00036 <span class="keyword">import</span> java.util.ArrayList;
00037 <span class="keyword">import</span> java.util.TreeMap;
00038 <span class="keyword">import</span> java.util.Iterator;
00039 
00040 <span class="keyword">import</span> org.argoprint.ArgoPrintDataSource;
00041 <span class="keyword">import</span> org.argoprint.engine.ArgoPrintIterator;
00042 <span class="keyword">import</span> org.argoprint.engine.Environment;
00043 <span class="keyword">import</span> org.w3c.dom.*;
00044 <span class="comment"></span>
00045 <span class="comment">/**</span>
00046 <span class="comment"> * Handles iteration through the ap:iterate tag.</span>
00047 <span class="comment"> */</span>
<a name="l00048"></a><a class="code" href="classorg_1_1argoprint_1_1engine_1_1interpreters_1_1InterpreterIterate.html">00048</a> <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="classorg_1_1argoprint_1_1engine_1_1interpreters_1_1InterpreterIterate.html">InterpreterIterate</a> <span class="keyword">extends</span> <a class="code" href="classorg_1_1argoprint_1_1engine_1_1interpreters_1_1Interpreter.html">Interpreter</a> {
00049 
<a name="l00050"></a><a class="code" href="classorg_1_1argoprint_1_1engine_1_1interpreters_1_1InterpreterIterate.html#a0">00050</a>     <span class="keyword">public</span> <a class="code" href="classorg_1_1argoprint_1_1engine_1_1interpreters_1_1InterpreterIterate.html#a0">InterpreterIterate</a>(<a class="code" href="interfaceorg_1_1argoprint_1_1ArgoPrintDataSource.html">ArgoPrintDataSource</a> dataSource) {
00051         super(<span class="stringliteral">"iterate"</span>, dataSource);
00052     }
00053 <span class="comment"></span>
00054 <span class="comment">    /**</span>
00055 <span class="comment">     * Processes the iterate tag.</span>
00056 <span class="comment">     * </span>
00057 <span class="comment">     * @param tagNode The tag to process.</span>
00058 <span class="comment">     * @param env The environment in which to process it.</span>
00059 <span class="comment">     */</span>
00060 
<a name="l00061"></a><a class="code" href="classorg_1_1argoprint_1_1engine_1_1interpreters_1_1InterpreterIterate.html#b0">00061</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> <a class="code" href="classorg_1_1argoprint_1_1engine_1_1interpreters_1_1InterpreterIterate.html#b0">processTag</a>(Node tagNode, <a class="code" href="classorg_1_1argoprint_1_1engine_1_1Environment.html">Environment</a> env) <span class="keywordflow">throws</span> Exception {
00062         NamedNodeMap attributes = tagNode.getAttributes();
00063         
00064         <span class="comment">// Get the collection</span>
00065         Object callReturnValue = <a class="code" href="classorg_1_1argoprint_1_1engine_1_1interpreters_1_1Interpreter.html#b2">callDataSource</a>(<span class="stringliteral">"what"</span>, attributes, env);
00066         <span class="keywordflow">if</span> (!(callReturnValue instanceof Collection) &amp;&amp; 
00067             !(callReturnValue instanceof Object)){
00068             <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception(<span class="stringliteral">"The object returned from the call to the data source is not a collection."</span>);
00069         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(callReturnValue instanceof Collection) &amp;&amp; 
00070                (callReturnValue instanceof Object)){
00071             ArrayList tmpCollection = <span class="keyword">new</span> ArrayList();
00072             tmpCollection.add(callReturnValue);
00073             callReturnValue = tmpCollection;
00074         }
00075         
00076         
00077         Collection iterateCollection = (Collection) callReturnValue;
00078 
00079         Node sortvalueAttribute = attributes.getNamedItem(<span class="stringliteral">"sortvalue"</span>);
00080         <span class="keywordflow">if</span> (sortvalueAttribute != null) {
00081             String sortvalue = sortvalueAttribute.getNodeValue();
00082             iterateCollection = sortCollection(iterateCollection, sortvalue);
00083         }
00084             
00085         Node iteratornameAttribute = attributes.getNamedItem(<span class="stringliteral">"iteratorname"</span>);
00086         <span class="keywordflow">if</span> (iteratornameAttribute == null) 
00087             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classorg_1_1argoprint_1_1engine_1_1interpreters_1_1BadTemplateException.html">BadTemplateException</a>(<span class="stringliteral">"Iterate tag contains no iteratorname attribute."</span>);
00088         String iteratorname = iteratornameAttribute.getNodeValue();
00089         
00090         <a class="code" href="classorg_1_1argoprint_1_1engine_1_1ArgoPrintIterator.html">ArgoPrintIterator</a> iterator = <span class="keyword">new</span> <a class="code" href="classorg_1_1argoprint_1_1engine_1_1ArgoPrintIterator.html">ArgoPrintIterator</a>(iterateCollection.iterator());
00091         env.addIterator(iteratorname, iterator);
00092 
00093         Document document = tagNode.getOwnerDocument();
00094         Node parentNode = tagNode.getParentNode();
00095         NodeList children = tagNode.getChildNodes();
00096         Node newNode;
00097 
00098         <span class="comment">// For every object in the iterator, clone every child, attach it to the parent and recurse</span>
00099         <span class="keywordflow">while</span> (iterator.<a class="code" href="classorg_1_1argoprint_1_1engine_1_1ArgoPrintIterator.html#a1">hasNext</a>()) {
00100             iterator.<a class="code" href="classorg_1_1argoprint_1_1engine_1_1ArgoPrintIterator.html#a2">next</a>();
00101             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; children.getLength(); i++) {
00102                 newNode = children.item(i).cloneNode(<span class="keyword">true</span>);
00103                 parentNode.insertBefore(newNode, tagNode);
00104                 <a class="code" href="classorg_1_1argoprint_1_1engine_1_1interpreters_1_1Interpreter.html#p0">_firstHandler</a>.<a class="code" href="classorg_1_1argoprint_1_1engine_1_1interpreters_1_1Interpreter.html#a4">handleTag</a>(newNode, env);
00105             }
00106         }
00107         env.removeIterator(iteratorname);
00108         parentNode.removeChild(tagNode);
00109     }
00110     <span class="comment"></span>
00111 <span class="comment">    /**</span>
00112 <span class="comment">     * Sorts a Collection according to a String returned by a call to the data source for each object in the collection. </span>
00113 <span class="comment">     * </span>
00114 <span class="comment">     * @param collection The collection to sort.</span>
00115 <span class="comment">     * @param sortvalue The call that will be applied to each object providing a value to sort on.</span>
00116 <span class="comment">     * @return A sorted Collection.</span>
00117 <span class="comment">     * @throws Exception</span>
00118 <span class="comment">     */</span>
00119     <span class="keyword">private</span> Collection sortCollection(Collection collection, String sortvalue) <span class="keywordflow">throws</span> Exception {
00120         Iterator iterator = collection.iterator();
00121         TreeMap sortedMap = <span class="keyword">new</span> TreeMap();
00122         Object object;
00123         Object returned;
00124         <span class="keywordflow">while</span> (iterator.hasNext()) {
00125             object = iterator.next();
00126             returned = <a class="code" href="classorg_1_1argoprint_1_1engine_1_1interpreters_1_1Interpreter.html#p1">_dataSource</a>.<a class="code" href="interfaceorg_1_1argoprint_1_1ArgoPrintDataSource.html#a0">caller</a>(sortvalue, object);
00127             <span class="keywordflow">if</span> (returned == null)
00128                 returned = <span class="stringliteral">"null"</span>;
00129             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(returned instanceof String))
00130                 <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception(<span class="stringliteral">"The sortvalue function did not return a String."</span>);
00131             sortedMap.put(returned, object);
00132         }
00133         <span class="keywordflow">return</span> sortedMap.values();
00134     }
00135 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Dec 2 22:50:56 2003 for ArgoPrint by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
